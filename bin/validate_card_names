#!/usr/bin/env ruby

require "set"
require "pathname"
require "pathname-glob"
require_relative "../lib/deck"

class ValidateCardNames
  attr_reader :has_errors

  def initialize(card_list_path)
    @valid_card_names = Pathname(card_list_path).readlines.map(&:chomp).to_set
    @has_errors = false
  end

  def data_root
    @data_root ||= Pathname(__dir__) + "../data"
  end

  def deck_files
    data_root.glob("*/*/*.txt")
  end

  def warn(*)
    @has_errors = true
    super
  end

  def validate_names(path, deck)
    deck.sections.each do |section_name, section_cards|
      # These are intentional
      unless path.to_s.split("/")[-3] == "demo"
        duplicate_entries = section_cards.map{|c| c.except(:count)}.tally.select{|k,v| v > 1}
        duplicate_entries.each do |entry, count|
          binding.pry
          warn "#{path}: #{section_name}: contains #{entry.inspect} multiple times"
        end
      end

      card_names = section_cards.reject{|c| c[:token]}.map{|c| c[:name]}.flat_map{|cn| cn.split(" // ") }.to_set - @valid_card_names
      card_names.each do |card_name|
        warn "#{path}: #{section_name}: Unknown card: #{card_name.inspect}"
      end
    end
  end

  def call
    deck_files.each do |path|
      deck = Deck.new(path)
      validate_names(path, deck)
    end
  end
end

path = ARGV[0] || Pathname(__dir__) + "../lib/valid_card_names.txt"
unless ARGV.size <= 1
  STDERR.puts "Usage: #{$0} valid_card_names.txt"
  exit 1
end

validator = ValidateCardNames.new(path)
validator.call
exit 1 if validator.has_errors
